# Check NEORV32 software framework and test processor

name: Processor

on:
  push:
    branches:
    - master
    paths:
    - 'rtl/**'
    - 'sw/**'
    - 'sim/**'
  pull_request:
    branches:
    - master
    paths:
    - 'rtl/**'
    - 'sw/**'
    - 'sim/**'
  workflow_dispatch:

jobs:


  Processor:
    runs-on: ubuntu-latest
    name: 'üêß Ubuntu | Shell script'

    steps:

    - name: 'üß∞ Repository Checkout'
      uses: actions/checkout@v2

    - name: 'üîß Setup Environment Variables'
      run: |
        echo "$GITHUB_WORKSPACE/riscv/bin" >> $GITHUB_PATH
        echo $GITHUB_WORKSPACE

    - name: '‚öôÔ∏è Setup RISC-V GCC'
      run: |
        mkdir riscv
        curl -fsSL https://github.com/stnolting/riscv-gcc-prebuilt/releases/download/rv32i-2.0.0/riscv32-unknown-elf.gcc-10.2.0.rv32i.ilp32.newlib.tar.gz | \
        tar -xzf - -C riscv
        ls -al riscv

    - name: '‚öôÔ∏è Setup GHDL Simulator'
      uses: ghdl/setup-ghdl-ci@nightly
      with:
        backend: llvm

    - name: 'üöß Run Software Framework Tests'
      run: ./sw/example/processor_check/check.sh

    - name: 'üöß Run Processor Hardware Tests with shell script'
      run: /bin/bash -c "chmod u+x ./sim/ghdl_sim.sh && ./sim/ghdl_sim.sh"


  VUnit-Container:
    runs-on: ubuntu-latest
    name: 'üõ≥Ô∏è Container | VUnit'

    steps:

    - name: 'üß∞ Repository Checkout'
      uses: actions/checkout@v2

    - name: 'üîß Setup Environment Variables'
      run: |
        echo "$GITHUB_WORKSPACE/riscv/bin" >> $GITHUB_PATH
        echo $GITHUB_WORKSPACE

    - name: '‚öôÔ∏è Setup RISC-V GCC'
      run: |
        mkdir riscv
        curl -fsSL https://github.com/stnolting/riscv-gcc-prebuilt/releases/download/rv32i-2.0.0/riscv32-unknown-elf.gcc-10.2.0.rv32i.ilp32.newlib.tar.gz | \
        tar -xzf - -C riscv
        ls -al riscv

    - name: '‚öôÔ∏è Build and install Processor Check software'
      run: |
        make -C sw/example/processor_check \
          clean_all \
          USER_FLAGS+=-DRUN_CHECK \
          USER_FLAGS+=-DUART0_SIM_MODE \
          MARCH=-march=rv32imac \
          info \
          all

    - name: 'üì§ Archive Processor Check application image'
      uses: actions/upload-artifact@v2
      with:
        name: application
        path: rtl/core/neorv32_application_image.vhd

    - name: 'üöß Run Processor Hardware Tests with VUnit'
      uses: VUnit/vunit_action@master
      with:
        cmd: ./sim/run.py --ci-mode -v
